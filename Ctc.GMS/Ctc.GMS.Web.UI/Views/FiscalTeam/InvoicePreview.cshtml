@model InvoicePreviewViewModel

@{
    ViewData["Title"] = "Invoice Preview";

    // Invoice Number Format: [GrantNumber]-[SequentialNumber]
    // Example: STSP-2526-LAUSD-001-01
    // The invoice number follows the grant number with a unique sequence at the end
    var invoiceSequence = "01"; // This would come from the database in production
    var formattedInvoiceNumber = $"{Model.GrantNumber}-{invoiceSequence}";
}

@section Breadcrumbs {
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="@Url.Action("Dashboard", "GrantsTeam")">Grants Team</a></li>
        <li class="breadcrumb-item active">Invoice Preview</li>
    </ol>
}

<div class="page-header">
    <h2><i class="mdi mdi-file-document-outline"></i> Invoice Preview</h2>
    <p class="subtitle">Review invoice before sending to accounting</p>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Invoice Document -->
        <div class="r4-card invoice-document">
            <div class="r4-card-body">
                <!-- Invoice Header -->
                <div class="invoice-header">
                    <div class="invoice-title">INVOICE</div>
                    <div class="invoice-meta">
                        <div class="invoice-meta-row">
                            <span class="label">Invoice Number:</span>
                            <span class="value invoice-number">@formattedInvoiceNumber</span>
                        </div>
                        <div class="invoice-meta-row">
                            <span class="label">Date:</span>
                            <span class="value">@Model.FormattedInvoiceDate</span>
                        </div>
                        <div class="invoice-meta-row">
                            <span class="label">PO Number:</span>
                            <span class="value">@Model.PONumber</span>
                        </div>
                    </div>
                </div>

                <!-- From / To Section -->
                <div class="invoice-parties">
                    <div class="invoice-from">
                        <h4>FROM:</h4>
                        <div class="party-name">@Model.GranteeName</div>
                        <div class="party-address">@Model.GranteeAddress</div>
                        <div class="party-address">@Model.GranteeCity, @Model.GranteeState @Model.GranteeZip</div>
                    </div>
                    <div class="invoice-to">
                        <h4>TO:</h4>
                        <div class="party-name">@Model.PayeeName</div>
                        <div class="party-address">@Model.PayeeAddress</div>
                        <div class="party-address">@Model.PayeeCityStateZip</div>
                    </div>
                </div>

                <!-- Program Section -->
                <div class="invoice-section">
                    <h4>FOR:</h4>
                    <div class="program-name">@Model.ProgramName</div>
                    <div class="program-desc">@Model.ProgramDescription</div>
                    <div class="grant-number">Grant Number: <strong>@Model.GrantNumber</strong></div>
                </div>

                <!-- Line Items Table -->
                <div class="invoice-section">
                    <h4>Description of Services</h4>
                    <table class="invoice-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th class="text-right">Unit Price</th>
                                <th class="text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Student Teacher Stipend Disbursements</td>
                                <td>@Model.StudentCount students</td>
                                <td class="text-right">$10,000.00</td>
                                <td class="text-right">@Model.FormattedAmount</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="invoice-total-row">
                                <td colspan="3" class="text-right"><strong>TOTAL:</strong></td>
                                <td class="text-right invoice-total">@Model.FormattedAmount</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Account Information -->
                <div class="invoice-section invoice-accounting">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="accounting-field">
                                <span class="label">ENY:</span>
                                <span class="value">@Model.ENY</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="accounting-field">
                                <span class="label">Account Code:</span>
                                <span class="value">@Model.AccountCode</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Student Detail (Attachment) -->
                <div class="invoice-section invoice-attachment">
                    <h4>Attachment: Student Detail</h4>
                    <table class="invoice-student-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Student Name</th>
                                <th>SEID</th>
                                <th>Credential Area</th>
                                <th class="text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.Students.Count; i++)
                            {
                                var student = Model.Students[i];
                                <tr>
                                    <td>@(i + 1)</td>
                                    <td>@student.StudentName</td>
                                    <td>@student.SEID</td>
                                    <td>@student.CredentialArea</td>
                                    <td class="text-right">@student.AwardAmount.ToString("C0")</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr class="invoice-total-row">
                                <td colspan="4" class="text-right"><strong>Total:</strong></td>
                                <td class="text-right"><strong>@Model.FormattedAmount</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Summary Card -->
        <div class="r4-card">
            <div class="r4-card-header">
                <h4><i class="mdi mdi-information-outline"></i> Invoice Summary</h4>
            </div>
            <div class="r4-card-body">
                <div class="summary-item">
                    <span class="summary-label">Invoice Number</span>
                    <span class="summary-value">@formattedInvoiceNumber</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Grant Number</span>
                    <span class="summary-value">@Model.GrantNumber</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Students</span>
                    <span class="summary-value">@Model.StudentCount</span>
                </div>
                <div class="summary-item highlight">
                    <span class="summary-label">Total Amount</span>
                    <span class="summary-value">@Model.FormattedAmount</span>
                </div>
                <hr style="border-color: var(--gray-300); margin: 1rem 0;" />
                <div class="summary-item">
                    <span class="summary-label">Grantee</span>
                    <span class="summary-value" style="font-size: 0.85rem;">@Model.GranteeName</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Invoice Date</span>
                    <span class="summary-value">@Model.FormattedInvoiceDate</span>
                </div>
            </div>
        </div>

        <!-- Actions Card -->
        <div class="r4-card">
            <div class="r4-card-header">
                <h4><i class="mdi mdi-checkbox-marked-outline"></i> Actions</h4>
            </div>
            <div class="r4-card-body">
                <div class="fiscal-checkbox-container">
                    <label class="fiscal-checkbox">
                        <input type="checkbox" id="fiscalSubmitted" onchange="markAsFiscalSubmitted(this)">
                        <span class="fiscal-checkbox-mark"></span>
                        <span class="fiscal-checkbox-label">Mark as submitted to CTC Accounting</span>
                    </label>
                </div>
                <hr style="border-color: var(--gray-200); margin: 1rem 0;" />
                <button type="button" class="r4-button r4-button-secondary r4-button-block" onclick="window.print()">
                    <i class="mdi mdi-download"></i> Download
                </button>
                <a href="@Url.Action("Dashboard", "GrantsTeam")" class="r4-button r4-button-outline r4-button-block" style="margin-top: 0.5rem;">
                    <i class="mdi mdi-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function markAsFiscalSubmitted(checkbox) {
            if (checkbox.checked) {
                // Mock: In production, this would POST to an endpoint
                const container = checkbox.closest('.fiscal-checkbox-container');
                container.classList.add('submitted');

                // Show confirmation
                const label = container.querySelector('.fiscal-checkbox-label');
                label.innerHTML = '<i class="mdi mdi-check-circle"></i> Submitted to CTC Accounting';
            }
        }
    </script>

    <style>
        /* Invoice Document Styling */
        .invoice-document {
            background: white;
            border: 1px solid var(--gray-300);
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--primary);
            margin-bottom: 1.5rem;
        }

        .invoice-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            letter-spacing: 0.1em;
        }

        .invoice-meta {
            text-align: right;
        }

        .invoice-meta-row {
            margin-bottom: 0.25rem;
        }

        .invoice-meta-row .label {
            color: var(--gray-600);
            margin-right: 0.5rem;
        }

        .invoice-meta-row .value {
            font-weight: 600;
        }

        .invoice-number {
            font-size: 1.1rem;
            color: var(--primary);
        }

        /* Parties Section */
        .invoice-parties {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .invoice-from h4,
        .invoice-to h4 {
            font-size: 0.85rem;
            color: var(--gray-500);
            margin-bottom: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .party-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .party-address {
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        /* Invoice Sections */
        .invoice-section {
            margin-bottom: 1.5rem;
        }

        .invoice-section h4 {
            font-size: 0.85rem;
            color: var(--gray-500);
            margin-bottom: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .program-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .program-desc {
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        .grant-number {
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        /* Invoice Table */
        .invoice-table,
        .invoice-student-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
        }

        .invoice-table th,
        .invoice-table td,
        .invoice-student-table th,
        .invoice-student-table td {
            padding: 0.75rem;
            border: 1px solid var(--gray-200);
        }

        .invoice-table th,
        .invoice-student-table th {
            background: var(--gray-100);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .invoice-total-row {
            background: var(--gray-50);
            font-weight: 600;
        }

        .invoice-total {
            font-size: 1.1rem;
            color: var(--primary);
        }

        .text-right {
            text-align: right;
        }

        /* Accounting Section */
        .invoice-accounting {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: 4px;
        }

        .accounting-field {
            display: flex;
            justify-content: space-between;
        }

        .accounting-field .label {
            font-weight: 600;
            color: var(--gray-600);
        }

        .accounting-field .value {
            font-family: monospace;
            font-size: 0.95rem;
        }

        /* FisCal Checkbox */
        .fiscal-checkbox-container {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid var(--gray-200);
            transition: all 0.2s ease;
        }

        .fiscal-checkbox-container.submitted {
            background: var(--success-light);
            border-color: var(--success);
        }

        .fiscal-checkbox {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 600;
            gap: 0.75rem;
        }

        .fiscal-checkbox input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: var(--success);
        }

        .fiscal-checkbox-label {
            font-size: 1rem;
            color: var(--gray-700);
        }

        .fiscal-checkbox-container.submitted .fiscal-checkbox-label {
            color: var(--success);
        }

        .fiscal-checkbox-container.submitted .fiscal-checkbox-label i {
            margin-right: 0.25rem;
        }

        /* Attachment */
        .invoice-attachment {
            border-top: 1px dashed var(--gray-300);
            padding-top: 1.5rem;
            margin-top: 1.5rem;
        }

        /* Summary Card */
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        .summary-value {
            font-weight: 600;
        }

        .summary-item.highlight {
            background: var(--primary-light);
            margin: 0.5rem -1rem;
            padding: 0.75rem 1rem;
            border-radius: 4px;
        }

        .summary-item.highlight .summary-value {
            font-size: 1.2rem;
            color: var(--primary);
        }

        /* Print Styles */
        @@media print {
            .r4-card:not(.invoice-document),
            .page-header,
            .breadcrumb,
            .col-lg-4 {
                display: none !important;
            }

            .col-lg-8 {
                width: 100% !important;
                max-width: 100% !important;
                flex: 0 0 100% !important;
            }

            .invoice-document {
                border: none !important;
                box-shadow: none !important;
            }
        }
    </style>
}
