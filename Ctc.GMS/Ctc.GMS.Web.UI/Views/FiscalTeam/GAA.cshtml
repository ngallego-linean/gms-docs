@model GAAListViewModel

@{
    ViewData["Title"] = "Generate GAA Documents";

    // Mock IHE institutions for POC diversification
    var mockIHEs = new[] {
        "San Diego State University",
        "UC San Diego",
        "Cal State San Marcos",
        "Point Loma Nazarene University",
        "University of San Diego",
        "CSU Fullerton"
    };
}

@section Breadcrumbs {
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="@Url.Action("Dashboard", "GrantsTeam")">Grants Team</a></li>
        <li class="breadcrumb-item active">Generate GAA Documents</li>
    </ol>
}

<div class="page-header">
    <h2><i class="mdi mdi-file-document-outline"></i> Generate Grant Award Agreements</h2>
    <p class="subtitle">@Model.GrantCycleName</p>
</div>

@if (!Model.DisbursementGroups.Any())
{
    <div class="alert alert-info">
        <i class="mdi mdi-information-outline"></i>
        No approved students are currently waiting for GAA generation. All GAAs have been processed.
    </div>
}
else
{
    <!-- Disbursement Groups -->
    @for (var groupIndex = 0; groupIndex < Model.DisbursementGroups.Count; groupIndex++)
    {
        var group = Model.DisbursementGroups[groupIndex];
        var groupId = $"group-{group.Id}";
        var collapseId = $"collapse-{group.Id}";
        var mockApprovedDate = DateTime.Now.AddDays(-3 - groupIndex);

        <div class="r4-card disbursement-group-card" data-lea="@group.LEAName" data-month="@group.SubmissionMonth">
            <div class="r4-card-header disbursement-group-header">
                <div class="group-header-content">
                    <div class="group-header-info" onclick="toggleCollapse('@collapseId')" aria-expanded="false">
                        <h4 class="group-header-title">
                            <i class="mdi mdi-chevron-right collapse-icon"></i>
                            <strong>@group.LEAName</strong>
                            <span class="badge badge-secondary badge-spacing">@group.SubmissionMonth</span>
                        </h4>
                        <p class="group-header-subtitle">
                            @group.StudentCount student(s) &bull; @group.TotalAmount.ToString("C0") total &bull; CTC Approved: @mockApprovedDate.ToString("MM/dd/yyyy")
                        </p>
                    </div>
                    <div class="card-actions">
                        <a href="@Url.Action("GAAPreview", "FiscalTeam", new { groupId = group.Id })" class="r4-button r4-button-secondary" style="margin-right: 0.5rem;">
                            <i class="mdi mdi-eye-outline"></i> Preview
                        </a>
                        <button type="button" class="r4-button r4-button-primary" onclick="generateGroupGAAs(@group.Id, @group.StudentCount)">
                            <i class="mdi mdi-file-sign"></i> Send to DocuSign
                        </button>
                    </div>
                </div>
            </div>
            <div id="@collapseId" class="collapse">
                <div class="r4-card-body">
                    <div class="table-wrapper">
                        <table class="r4-table gaa-table">
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>SEID</th>
                                    <th>IHE Institution</th>
                                    <th>Credential Area</th>
                                    <th>Award Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (var studentIndex = 0; studentIndex < group.Students.Count; studentIndex++)
                                {
                                    var student = group.Students[studentIndex];
                                    var displayIHE = mockIHEs[studentIndex % mockIHEs.Length];
                                    <tr class="student-row" data-student-name="@student.StudentName.ToLower()">
                                        <td><strong>@student.StudentName</strong></td>
                                        <td>@student.SEID</td>
                                        <td class="col-wrap">@displayIHE</td>
                                        <td>
                                            <span class="badge badge-primary">@student.CredentialArea</span>
                                        </td>
                                        <td><strong>@student.AwardAmount.ToString("C0")</strong></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Global Actions -->
    <div class="r4-card">
        <div class="r4-card-body">
            <button type="button" class="r4-button r4-button-success" onclick="generateAllGAAs()">
                <i class="mdi mdi-file-document-check-outline"></i> Generate All GAAs for All Groups
            </button>
        </div>
    </div>
}

@section Scripts {
    <script>
        // Generate all GAAs for an entire disbursement group - sends to DocuSign
        async function generateGroupGAAs(groupId, studentCount) {
            if (!confirm(`Send GAA for ${studentCount} student(s) to DocuSign for signature?\n\nThis will create a Grant Award Agreement and open the DocuSign signing ceremony.`)) {
                return;
            }

            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Sending to DocuSign...';

            try {
                const response = await fetch(`/FiscalTeam/SendGAA/${groupId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success && result.signingUrl) {
                    // Open DocuSign signing ceremony in new tab
                    window.open(result.signingUrl, '_blank');
                    button.innerHTML = '<i class="mdi mdi-check"></i> Sent to DocuSign';
                    button.classList.remove('r4-button-primary');
                    button.classList.add('r4-button-success');
                } else {
                    throw new Error(result.error || 'Failed to send to DocuSign');
                }
            } catch (error) {
                console.error('DocuSign error:', error);
                alert('Error sending to DocuSign: ' + error.message);
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        // Generate all GAAs for all groups
        function generateAllGAAs() {
            const totalCount = @Model.TotalStudents;
            const groupCount = @Model.TotalGroups;

            alert(`Batch DocuSign sending for ${totalCount} student(s) across ${groupCount} group(s) is not yet implemented.\n\nPlease send each group individually for now.`);
        }

        // Toggle collapse panel and rotate chevron icon
        function toggleCollapse(collapseId) {
            const collapseDiv = document.getElementById(collapseId);
            const header = collapseDiv.closest('.r4-card').querySelector('.group-header-info');
            const icon = header.querySelector('.collapse-icon');

            if (collapseDiv.classList.contains('show')) {
                // Collapse: hide content and rotate icon to right
                collapseDiv.classList.remove('show');
                icon.classList.remove('mdi-chevron-down');
                icon.classList.add('mdi-chevron-right');
                header.setAttribute('aria-expanded', 'false');
            } else {
                // Expand: show content and rotate icon to down
                collapseDiv.classList.add('show');
                icon.classList.remove('mdi-chevron-right');
                icon.classList.add('mdi-chevron-down');
                header.setAttribute('aria-expanded', 'true');
            }
        }
    </script>

    <style>
        /* Collapse show/hide behavior */
        .collapse {
            display: none;
        }

        .collapse.show {
            display: block;
        }

        /* Collapsible header styling */
        .group-header-info {
            cursor: pointer;
        }

        .group-header-info:hover {
            opacity: 0.85;
        }

        .collapse-icon {
            transition: transform 0.2s ease;
            margin-right: 0.5rem;
        }

        /* Group header layout */
        .group-header-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
        }

        .group-header-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .group-header-subtitle {
            margin: 0;
            color: var(--gray-600);
            font-size: 0.875rem;
            padding-left: 1.75rem;
        }

        .badge-spacing {
            margin-left: 0.5rem;
        }
    </style>
}
