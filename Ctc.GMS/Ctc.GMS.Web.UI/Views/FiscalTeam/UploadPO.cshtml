@{
    ViewData["Title"] = "Bulk PO Upload";
}

@section Breadcrumbs {
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="@Url.Action("Dashboard", "GrantsTeam")">Grants Team</a></li>
        <li class="breadcrumb-item active">Bulk PO Upload</li>
    </ol>
}

<div class="page-header">
    <h2><i class="mdi mdi-file-upload-outline"></i> Bulk Purchase Order Upload</h2>
    <p class="subtitle">Upload PO documents - data is automatically extracted</p>
</div>

<div class="page-actions">
    <a href="@Url.Action("Dashboard", "GrantsTeam")" class="r4-button r4-button-secondary">
        <i class="mdi mdi-arrow-left"></i> Back to Dashboard
    </a>
</div>

<!-- Upload Section -->
<div class="r4-card" id="uploadCard">
    <div class="r4-card-header">
        <h4><i class="mdi mdi-file-pdf-box"></i> Upload Purchase Order</h4>
    </div>
    <div class="r4-card-body">
        <div class="file-upload-area" id="dropZone">
            <i class="mdi mdi-cloud-upload-outline"></i>
            <p>Drag & drop your PO file here or</p>
            <label for="poFiles" class="r4-button r4-button-secondary r4-button-sm">
                <i class="mdi mdi-folder-open-outline"></i> Browse Files
            </label>
            <input type="file" id="poFiles" name="poFiles" accept=".pdf" class="file-input" />
            <p class="file-types">Accepted format: PDF (Fi$Cal Purchase Order)</p>
        </div>
    </div>
</div>

<!-- Processing State (hidden by default) -->
<div class="r4-card" id="processingCard" style="display: none;">
    <div class="r4-card-body" style="text-align: center; padding: 3rem;">
        <div class="processing-spinner"></div>
        <p style="margin-top: 1rem; color: var(--gray-600);">Extracting data from PO document...</p>
    </div>
</div>

<!-- Parsed Results (hidden by default) -->
<div class="r4-card" id="parsedResultsCard" style="display: none;">
    <div class="r4-card-header">
        <h4><i class="mdi mdi-check-circle text-success"></i> Data Extracted Successfully</h4>
    </div>
    <div class="r4-card-body">
        <div class="parsed-data-grid">
            <div class="parsed-field">
                <span class="parsed-label">PO Number</span>
                <span class="parsed-value" id="parsedPONumber">-</span>
            </div>
            <div class="parsed-field">
                <span class="parsed-label">PO Date</span>
                <span class="parsed-value" id="parsedPODate">-</span>
            </div>
            <div class="parsed-field">
                <span class="parsed-label">Supplier</span>
                <span class="parsed-value" id="parsedSupplier">-</span>
            </div>
            <div class="parsed-field">
                <span class="parsed-label">Total Amount</span>
                <span class="parsed-value parsed-amount" id="parsedAmount">-</span>
            </div>
        </div>

        <div class="parsed-file-info">
            <i class="mdi mdi-file-pdf-box"></i>
            <span id="parsedFileName">-</span>
            <button type="button" class="r4-button r4-button-sm r4-button-outline" onclick="resetUpload()">
                <i class="mdi mdi-close"></i> Remove
            </button>
        </div>

        <!-- Match Section -->
        <div class="match-section">
            <h5><i class="mdi mdi-link-variant"></i> Match to Submission</h5>
            <div class="r4-alert r4-alert-success" id="autoMatchAlert" style="display: none;">
                <i class="mdi mdi-check-circle"></i>
                <div>
                    <strong>Auto-matched!</strong> Supplier name matches <span id="matchedDistrict">-</span>
                </div>
            </div>
            <div class="match-options" id="matchOptions">
                <label class="match-option">
                    <input type="radio" name="matchSubmission" value="tehama" checked>
                    <div class="match-option-content">
                        <span class="match-district">Tehama County Dept of Education</span>
                        <span class="match-details">Nov 8, 2025 - 6 candidates - $60,000</span>
                    </div>
                </label>
                <label class="match-option">
                    <input type="radio" name="matchSubmission" value="lausd">
                    <div class="match-option-content">
                        <span class="match-district">Los Angeles Unified School District</span>
                        <span class="match-details">Nov 15, 2025 - 8 candidates - $80,000</span>
                    </div>
                </label>
                <label class="match-option">
                    <input type="radio" name="matchSubmission" value="sdusd">
                    <div class="match-option-content">
                        <span class="match-district">San Diego Unified School District</span>
                        <span class="match-details">Nov 12, 2025 - 5 candidates - $50,000</span>
                    </div>
                </label>
            </div>
        </div>

        <div class="form-actions">
            <button type="button" class="r4-button r4-button-secondary" onclick="resetUpload()">
                <i class="mdi mdi-close"></i> Cancel
            </button>
            <button type="button" class="r4-button r4-button-primary" onclick="confirmUpload()">
                <i class="mdi mdi-check"></i> Confirm & Save PO
            </button>
        </div>
    </div>
</div>

<!-- Success State (hidden by default) -->
<div class="r4-card" id="successCard" style="display: none;">
    <div class="r4-card-body" style="text-align: center; padding: 3rem;">
        <div class="success-icon">
            <i class="mdi mdi-check-circle"></i>
        </div>
        <h3 style="margin: 1rem 0 0.5rem;">PO Successfully Linked</h3>
        <p style="color: var(--gray-600); margin-bottom: 1.5rem;">
            PO <strong id="successPONumber">-</strong> has been linked to <strong id="successDistrict">-</strong>
        </p>
        <div style="display: flex; gap: 1rem; justify-content: center;">
            <button type="button" class="r4-button r4-button-secondary" onclick="uploadAnother()">
                <i class="mdi mdi-plus"></i> Upload Another PO
            </button>
            <a href="@Url.Action("Dashboard", "GrantsTeam")" class="r4-button r4-button-primary">
                <i class="mdi mdi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Pending Submissions Table -->
<div class="r4-card" id="pendingTable">
    <div class="r4-card-header">
        <h4><i class="mdi mdi-clock-outline"></i> Submissions Awaiting PO</h4>
    </div>
    <div class="r4-card-body">
        <div class="table-wrapper">
            <table class="r4-table">
                <thead>
                    <tr>
                        <th>LEA / COE</th>
                        <th>Submission Date</th>
                        <th>Candidates</th>
                        <th>Amount</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="pendingTableBody">
                    <tr data-district="tehama">
                        <td>Tehama County Dept of Education</td>
                        <td>Nov 8, 2025</td>
                        <td>6</td>
                        <td>$60,000</td>
                        <td><span class="status-badge status-pending">Awaiting PO</span></td>
                    </tr>
                    <tr data-district="lausd">
                        <td>Los Angeles Unified School District</td>
                        <td>Nov 15, 2025</td>
                        <td>8</td>
                        <td>$80,000</td>
                        <td><span class="status-badge status-pending">Awaiting PO</span></td>
                    </tr>
                    <tr data-district="sdusd">
                        <td>San Diego Unified School District</td>
                        <td>Nov 12, 2025</td>
                        <td>5</td>
                        <td>$50,000</td>
                        <td><span class="status-badge status-pending">Awaiting PO</span></td>
                    </tr>
                    <tr data-district="fresno">
                        <td>Fresno Unified School District</td>
                        <td>Nov 10, 2025</td>
                        <td>3</td>
                        <td>$30,000</td>
                        <td><span class="status-badge status-pending">Awaiting PO</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Upload History -->
<div class="r4-card">
    <div class="r4-card-header">
        <h4><i class="mdi mdi-history"></i> PO Upload History</h4>
    </div>
    <div class="r4-card-body">
        <div class="table-wrapper">
            <table class="r4-table">
                <thead>
                    <tr>
                        <th>PO Number</th>
                        <th>LEA / COE</th>
                        <th>Amount</th>
                        <th>Upload Date</th>
                        <th>Uploaded By</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>6360-0000004215</code></td>
                        <td>Sacramento City USD</td>
                        <td>$120,000</td>
                        <td>Oct 15, 2025</td>
                        <td>Sara S.</td>
                        <td><a href="#" class="r4-button r4-button-sm"><i class="mdi mdi-eye-outline"></i> View</a></td>
                    </tr>
                    <tr>
                        <td><code>6360-0000004198</code></td>
                        <td>Oakland USD</td>
                        <td>$80,000</td>
                        <td>Sep 20, 2025</td>
                        <td>Sara S.</td>
                        <td><a href="#" class="r4-button r4-button-sm"><i class="mdi mdi-eye-outline"></i> View</a></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const fileInput = document.getElementById('poFiles');
        const dropZone = document.getElementById('dropZone');
        const uploadCard = document.getElementById('uploadCard');
        const processingCard = document.getElementById('processingCard');
        const parsedResultsCard = document.getElementById('parsedResultsCard');
        const successCard = document.getElementById('successCard');

        // Mock parsed data (simulating what backend would return)
        const mockParsedData = {
            poNumber: '6360-0000004237',
            poDate: '05-09-2025',
            supplier: 'TEHAMA CNTY DEPT OF EDUCATION',
            amount: '$2,400,000.00'
        };

        // File input change handler
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                processFile(this.files[0]);
            }
        });

        // Drag and drop handlers
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) {
                processFile(e.dataTransfer.files[0]);
            }
        });

        function processFile(file) {
            // Show processing state
            uploadCard.style.display = 'none';
            processingCard.style.display = 'block';

            // Simulate PDF parsing delay
            setTimeout(() => {
                showParsedResults(file);
            }, 1500);
        }

        function showParsedResults(file) {
            processingCard.style.display = 'none';
            parsedResultsCard.style.display = 'block';

            // Populate parsed data
            document.getElementById('parsedPONumber').textContent = mockParsedData.poNumber;
            document.getElementById('parsedPODate').textContent = mockParsedData.poDate;
            document.getElementById('parsedSupplier').textContent = mockParsedData.supplier;
            document.getElementById('parsedAmount').textContent = mockParsedData.amount;
            document.getElementById('parsedFileName').textContent = file.name;

            // Show auto-match alert
            document.getElementById('autoMatchAlert').style.display = 'flex';
            document.getElementById('matchedDistrict').textContent = 'Tehama County Dept of Education';

            // Highlight matched row in pending table
            document.querySelector('tr[data-district="tehama"]').classList.add('matched-row');
        }

        function resetUpload() {
            parsedResultsCard.style.display = 'none';
            successCard.style.display = 'none';
            uploadCard.style.display = 'block';
            fileInput.value = '';

            // Reset highlights
            document.querySelectorAll('.matched-row').forEach(row => {
                row.classList.remove('matched-row');
            });
            document.getElementById('autoMatchAlert').style.display = 'none';
        }

        function confirmUpload() {
            const selectedMatch = document.querySelector('input[name="matchSubmission"]:checked').value;
            const districtNames = {
                'tehama': 'Tehama County Dept of Education',
                'lausd': 'Los Angeles Unified School District',
                'sdusd': 'San Diego Unified School District'
            };

            // Show success state
            parsedResultsCard.style.display = 'none';
            successCard.style.display = 'block';

            document.getElementById('successPONumber').textContent = mockParsedData.poNumber;
            document.getElementById('successDistrict').textContent = districtNames[selectedMatch];

            // Remove from pending table
            const matchedRow = document.querySelector(`tr[data-district="${selectedMatch}"]`);
            if (matchedRow) {
                matchedRow.style.transition = 'opacity 0.3s ease';
                matchedRow.style.opacity = '0';
                setTimeout(() => matchedRow.remove(), 300);
            }
        }

        function uploadAnother() {
            successCard.style.display = 'none';
            uploadCard.style.display = 'block';
            fileInput.value = '';
        }
    </script>

    <style>
        .file-upload-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            border: 2px dashed var(--gray-300);
            border-radius: 8px;
            background: var(--gray-50);
            text-align: center;
            transition: all 0.2s ease;
        }

        .file-upload-area:hover,
        .file-upload-area.drag-over {
            border-color: var(--ctc-blue);
            background: rgba(0, 86, 179, 0.05);
        }

        .file-upload-area i {
            font-size: 3rem;
            color: var(--gray-400);
            margin-bottom: 1rem;
        }

        .file-upload-area p {
            color: var(--gray-600);
            margin: 0 0 1rem 0;
        }

        .file-upload-area .file-types {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 1rem;
            margin-bottom: 0;
        }

        .file-input {
            position: absolute;
            width: 1px;
            height: 1px;
            opacity: 0;
            overflow: hidden;
        }

        /* Processing Spinner */
        .processing-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--ctc-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @@keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Parsed Data Grid */
        .parsed-data-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            padding: 1.5rem;
            background: var(--gray-50);
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .parsed-field {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .parsed-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
        }

        .parsed-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .parsed-value.parsed-amount {
            color: var(--success);
        }

        .parsed-file-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: rgba(0, 86, 179, 0.08);
            border: 1px solid var(--ctc-blue);
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .parsed-file-info i {
            font-size: 1.5rem;
            color: var(--ctc-blue);
        }

        .parsed-file-info span {
            flex: 1;
            font-weight: 500;
            color: var(--ctc-blue);
        }

        /* Match Section */
        .match-section {
            border-top: 1px solid var(--gray-200);
            padding-top: 1.5rem;
            margin-top: 1rem;
        }

        .match-section h5 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 1rem;
        }

        .match-section h5 i {
            margin-right: 0.5rem;
            color: var(--gray-500);
        }

        .match-options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .match-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .match-option:hover {
            border-color: var(--gray-300);
            background: var(--gray-50);
        }

        .match-option:has(input:checked) {
            border-color: var(--ctc-blue);
            background: rgba(0, 86, 179, 0.05);
        }

        .match-option input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: var(--ctc-blue);
        }

        .match-option-content {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }

        .match-district {
            font-weight: 600;
            color: var(--gray-900);
        }

        .match-details {
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        /* Form Actions */
        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--gray-200);
        }

        /* Success State */
        .success-icon {
            width: 64px;
            height: 64px;
            background: rgba(40, 167, 69, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        .success-icon i {
            font-size: 2.5rem;
            color: var(--success);
        }

        /* Matched Row Highlight */
        .matched-row {
            background: rgba(0, 86, 179, 0.08) !important;
        }

        .matched-row td:first-child::before {
            content: '\F012C';
            font-family: 'Material Design Icons';
            margin-right: 0.5rem;
            color: var(--ctc-blue);
        }

        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.15);
            color: #856404;
        }

        /* Alert styling */
        .r4-alert {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .r4-alert-success {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .r4-alert i {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .text-success {
            color: var(--success) !important;
        }

        code {
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 0.85em;
            background: var(--gray-100);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
        }
    </style>
}
