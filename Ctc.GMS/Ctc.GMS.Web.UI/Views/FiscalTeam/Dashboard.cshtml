@model DashboardViewModel

@{
    ViewData["Title"] = "Fiscal Team Dashboard";
}

@section Breadcrumbs {
    <ol class="breadcrumb">
        <li class="breadcrumb-item active">Fiscal Team Dashboard</li>
    </ol>
}

<div class="page-header">
    <h2><i class="mdi mdi-currency-usd"></i> Fiscal Team Dashboard</h2>
    <p class="subtitle">@Model.GrantCycleName</p>
</div>

@* ACTION ITEMS - Always at the top for immediate visibility *@
@if (Model.ActionItems.Any())
{
    <div class="r4-card">
        <div class="r4-card-header">
            <h4><i class="mdi mdi-bell-outline"></i> Action Items</h4>
        </div>
        <div class="r4-card-body">
            @foreach (var item in Model.ActionItems)
            {
                <div class="action-item @(item.Priority == "urgent" || item.Priority == "high" ? "action-item-urgent" : "action-item-normal")">
                    <div class="action-item-content">
                        <div class="action-item-icon">
                            <i class="mdi @(item.Type == "gaa_generation" ? "mdi-file-document-outline" : item.Type == "invoice_generation" ? "mdi-file-document-edit-outline" : "mdi-clipboard-check-outline")"></i>
                        </div>
                        <div class="action-item-details">
                            <h5>@item.Title</h5>
                            <p>@item.Description</p>
                            @if (item.DueDate.HasValue)
                            {
                                <p class="action-item-due">Due: @item.DueDate.Value.ToString("MMM dd, yyyy")</p>
                            }
                        </div>
                    </div>
                    <div class="action-item-actions">
                        @if (item.Type == "gaa_generation")
                        {
                            <a href="@Url.Action("GAA", "FiscalTeam", new { grantCycleId = Model.GrantCycleId })" class="r4-button r4-button-primary">
                                <i class="mdi mdi-arrow-right"></i> Process GAA
                            </a>
                        }
                        else if (item.Type == "invoice_generation")
                        {
                            <a href="@Url.Action("Invoices", "FiscalTeam", new { grantCycleId = Model.GrantCycleId })" class="r4-button r4-button-primary">
                                <i class="mdi mdi-arrow-right"></i> Process Invoices
                            </a>
                        }
                        else
                        {
                            <a href="#" class="r4-button r4-button-primary">
                                <i class="mdi mdi-arrow-right"></i> Process
                            </a>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
}

@* APPLICATION RESULTS *@
@if (Model.ApplicationResults != null && Model.ApplicationResults.Any())
{
    <div class="r4-card">
        <div class="r4-card-header">
            <h4><i class="mdi mdi-file-document-outline"></i> Application Results</h4>
        </div>
        <div class="r4-card-body">
            <div class="table-wrapper">
                <table class="r4-table">
                    <thead>
                        <tr>
                            <th>Submission Date</th>
                            <th>LEA</th>
                            <th>IHE</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var result in Model.ApplicationResults)
                        {
                            <tr>
                                <td>@result.SubmissionDate.ToString("MM/dd/yyyy")</td>
                                <td>@result.LEAName</td>
                                <td>@result.IHEName</td>
                                <td>
                                    <a href="#" class="r4-button r4-button-sm">
                                        <i class="mdi mdi-eye-outline"></i> View
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

@* APPLICATIONS WITH PENDING STUDENTS *@
@if (Model.ApplicationsWithPendingStudents != null && Model.ApplicationsWithPendingStudents.Any())
{
    <div class="r4-card">
        <div class="r4-card-header">
            <h4><i class="mdi mdi-folder-open-outline"></i> Applications with Pending Students</h4>
        </div>
        <div class="r4-card-body">
            <div class="table-wrapper">
                <table class="r4-table">
                    <thead>
                        <tr>
                            <th>Submission Date</th>
                            <th>LEA</th>
                            <th>Pending</th>
                            <th>Approved</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var app in Model.ApplicationsWithPendingStudents)
                        {
                            <tr>
                                <td>@app.SubmissionDate.ToString("MM/dd/yyyy")</td>
                                <td>@app.LEAName</td>
                                <td>
                                    <span class="badge badge-warning">@app.PendingCount</span>
                                </td>
                                <td>
                                    <span class="badge badge-success">@app.ApprovedCount</span>
                                </td>
                                <td>
                                    <a href="#" class="r4-button r4-button-sm">
                                        <i class="mdi mdi-eye-outline"></i> View
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

<div class="r4-card">
    <div class="r4-card-header">
        <h4><i class="mdi mdi-file-document-outline"></i> GAA Processing Status</h4>
        <div class="card-actions">
            <a href="@Url.Action("GAA", "FiscalTeam", new { grantCycleId = Model.GrantCycleId })" class="r4-button r4-button-primary">
                <i class="mdi mdi-file-plus-outline"></i> Generate GAAs
            </a>
        </div>
    </div>
    <div class="r4-card-body">
        <div class="dashboard-grid">
            <div class="metric-card metric-pending">
                <div class="metric-icon">
                    <i class="mdi mdi-clock-outline"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value">@Model.PendingReviewCount</div>
                    <div class="metric-label">Pending GAA</div>
                    <div class="metric-description">Approved students needing GAA</div>
                </div>
            </div>

            <div class="metric-card metric-approved">
                <div class="metric-icon">
                    <i class="mdi mdi-check-circle-outline"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value">@Model.Metrics.StatusCounts.Approved</div>
                    <div class="metric-label">Total Approved</div>
                    <div class="metric-description">All approved students</div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-icon">
                    <i class="mdi mdi-file-document-check-outline"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value">0</div>
                    <div class="metric-label">GAAs Generated</div>
                    <div class="metric-description">Agreements created this cycle</div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-icon">
                    <i class="mdi mdi-email-send-outline"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value">0</div>
                    <div class="metric-label">Sent via DocuSign</div>
                    <div class="metric-description">Awaiting signatures</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="r4-card">
    <div class="r4-card-header">
        <h4><i class="mdi mdi-chart-bar"></i> Budget Utilization</h4>
    </div>
    <div class="r4-card-body">
        <div class="budget-progress budget-progress-inline">
            @{
                // Helper function to format large currency amounts
                string FormatCurrency(decimal amount)
                {
                    if (amount >= 1_000_000_000)
                        return $"${(amount / 1_000_000_000):F1}B";
                    else if (amount >= 1_000_000)
                        return $"${(amount / 1_000_000):F1}M";
                    else if (amount >= 1_000)
                        return $"${(amount / 1_000):F1}K";
                    else
                        return amount.ToString("C0");
                }

                // Calculate percentages for each budget category
                var reservedPercent = Model.Metrics.ApproprietedAmount > 0
                    ? (Model.Metrics.ReservedAmount / Model.Metrics.ApproprietedAmount * 100)
                    : 0;

                var encumberedPercent = Model.Metrics.ApproprietedAmount > 0
                    ? (Model.Metrics.EncumberedAmount / Model.Metrics.ApproprietedAmount * 100)
                    : 0;

                var disbursedPercent = Model.Metrics.ApproprietedAmount > 0
                    ? (Model.Metrics.DisbursedAmount / Model.Metrics.ApproprietedAmount * 100)
                    : 0;

                var remainingPercent = Model.Metrics.ApproprietedAmount > 0
                    ? (Model.Metrics.RemainingAmount / Model.Metrics.ApproprietedAmount * 100)
                    : 0;
            }
            <div class="r4-progress" title="Hover over each section to see percentages">
                @* Reserved Amount *@
                @if (reservedPercent > 0.1m)
                {
                    <div class="r4-progress-bar r4-progress-bar-reserved"
                         style="width: @reservedPercent%;"
                         role="progressbar"
                         aria-valuenow="@reservedPercent"
                         title="Reserved: @reservedPercent.ToString("F1")%">
                        @if (reservedPercent > 8)
                        {
                            @FormatCurrency(Model.Metrics.ReservedAmount) <text>Reserved</text>
                        }
                    </div>
                }
                @* Encumbered Amount *@
                @if (encumberedPercent > 0.1m)
                {
                    <div class="r4-progress-bar r4-progress-bar-encumbered"
                         style="width: @encumberedPercent%;"
                         role="progressbar"
                         aria-valuenow="@encumberedPercent"
                         title="Encumbered: @encumberedPercent.ToString("F1")%">
                        @if (encumberedPercent > 8)
                        {
                            @FormatCurrency(Model.Metrics.EncumberedAmount) <text>Encumbered</text>
                        }
                    </div>
                }
                @* Disbursed Amount *@
                @if (disbursedPercent > 0.1m)
                {
                    <div class="r4-progress-bar r4-progress-bar-disbursed"
                         style="width: @disbursedPercent%;"
                         role="progressbar"
                         aria-valuenow="@disbursedPercent"
                         title="Disbursed: @disbursedPercent.ToString("F1")%">
                        @if (disbursedPercent > 8)
                        {
                            @FormatCurrency(Model.Metrics.DisbursedAmount) <text>Disbursed</text>
                        }
                    </div>
                }
                @* Remaining Amount *@
                @if (remainingPercent > 0.1m)
                {
                    <div class="r4-progress-bar r4-progress-bar-remaining"
                         style="width: @remainingPercent%;"
                         role="progressbar"
                         aria-valuenow="@remainingPercent"
                         title="Remaining: @remainingPercent.ToString("F1")%">
                        @if (remainingPercent > 8)
                        {
                            @FormatCurrency(Model.Metrics.RemainingAmount) <text>Remaining</text>
                        }
                    </div>
                }
            </div>
            <div class="budget-legend">
                <span><strong>Appropriated:</strong> @Model.Metrics.ApproprietedAmount.ToString("C0")</span>
                @if (Model.Metrics.ReservedAmount > 0)
                {
                    <span style="color: var(--warning);"><strong>Reserved:</strong> @Model.Metrics.ReservedAmount.ToString("C0") (@reservedPercent.ToString("F1")%)</span>
                }
                <span style="color: var(--gray-600);"><strong>Encumbered:</strong> @Model.Metrics.EncumberedAmount.ToString("C0") (@encumberedPercent.ToString("F1")%)</span>
                @if (Model.Metrics.DisbursedAmount > 0)
                {
                    <span style="color: var(--primary);"><strong>Disbursed:</strong> @Model.Metrics.DisbursedAmount.ToString("C0") (@disbursedPercent.ToString("F1")%)</span>
                }
                <span><strong>Remaining:</strong> @Model.Metrics.RemainingAmount.ToString("C0") (@remainingPercent.ToString("F1")%)</span>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Auto-refresh dashboard every 5 minutes
        setTimeout(function() {
            location.reload();
        }, 300000);
    </script>
}
