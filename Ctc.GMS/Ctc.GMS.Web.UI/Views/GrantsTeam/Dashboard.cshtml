@model DashboardViewModel

@{
    ViewData["Title"] = "Grants/Fiscal Team Dashboard";
}

@section Breadcrumbs {
    <ol class="breadcrumb">
        <li class="breadcrumb-item active">Grants/Fiscal Team Dashboard</li>
    </ol>
}

<div class="page-header">
    <h2><i class="mdi mdi-clipboard-check-outline"></i> Grants/Fiscal Team Dashboard</h2>
    <p class="subtitle">@Model.GrantCycleName</p>
</div>

@* GRANTS TEAM - Disbursement Groups Awaiting Review *@
@if (Model.ApplicationsWithPendingStudents.Any())
{
    <div class="r4-card">
        <div class="r4-card-header">
            <h4><i class="mdi mdi-folder-open-outline"></i> Applications with Pending Students</h4>
            <div class="card-actions">
                <a href="@Url.Action("Review", "GrantsTeam", new { grantCycleId = Model.GrantCycleId })" class="r4-button r4-button-sm r4-button-primary">
                    <i class="mdi mdi-eye-outline"></i> Review Queue
                </a>
            </div>
        </div>
        <div class="r4-card-body">
            <div class="table-wrapper">
                <table class="r4-table">
                    <thead>
                        <tr>
                            <th>Submission Date</th>
                            <th>LEA District</th>
                            <th>Total Students</th>
                            <th>Pending</th>
                            <th>Approved</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var app in Model.ApplicationsWithPendingStudents.Take(3))
                        {
                            <tr>
                                <td>@app.LastModified.ToString("MM/dd/yyyy")</td>
                                <td>@app.LEAName</td>
                                <td>@app.TotalStudents</td>
                                <td>
                                    <span class="badge badge-warning">@app.PendingCount</span>
                                </td>
                                <td>
                                    <span class="badge badge-success">@app.ApprovedCount</span>
                                </td>
                                <td>
                                    <div style="width: 160px; display: block;">
                                        <a href="@Url.Action("Details", "Application", new { id = app.Id })" class="r4-button r4-button-sm">
                                            <i class="mdi mdi-eye-outline"></i> View Detail
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

@* FISCAL TEAM - Disbursement Processing *@
<div class="r4-card">
    <div class="r4-card-header">
        <h4><i class="mdi mdi-file-document-outline"></i> Disbursement Processing</h4>
    </div>
    <div class="r4-card-body">
        @{
            // MOCK DATA: Unified disbursement groups in processing pipeline
            // Each record has a State property that determines the action and last action display
            var disbursementGroups = new List<dynamic>
            {
                new { SubmissionDate = DateTime.Now.AddDays(-5), LEA = "Fresno Unified School District", LastAction = "Approved", LastActionDate = DateTime.Now.AddDays(-1), Amount = 67500m, State = "NEEDS_GAA", Id = 1 },
                new { SubmissionDate = DateTime.Now.AddDays(-7), LEA = "Sacramento City Unified School District", LastAction = "Approved", LastActionDate = DateTime.Now.AddDays(-2), Amount = 48000m, State = "NEEDS_GAA", Id = 2 },
                new { SubmissionDate = DateTime.Now.AddDays(-10), LEA = "Oakland Unified School District", LastAction = "Approved", LastActionDate = DateTime.Now.AddDays(-3), Amount = 42000m, State = "NEEDS_GAA", Id = 3 },
                new { SubmissionDate = DateTime.Now.AddDays(-15), LEA = "Los Angeles Unified School District", LastAction = "GAA Signed", LastActionDate = DateTime.Now.AddDays(-2), Amount = 125000m, State = "NEEDS_INVOICE", Id = 4 },
                new { SubmissionDate = DateTime.Now.AddDays(-20), LEA = "San Diego Unified School District", LastAction = "GAA Signed", LastActionDate = DateTime.Now.AddDays(-1), Amount = 87500m, State = "NEEDS_INVOICE", Id = 5 },
                new { SubmissionDate = DateTime.Now.AddDays(-25), LEA = "Long Beach Unified School District", LastAction = "Invoice Generated", LastActionDate = DateTime.Now.AddDays(-1), Amount = 52500m, State = "INVOICE_GENERATED", Id = 6 }
            };
        }

        @if (disbursementGroups.Any())
        {
            <div class="table-wrapper">
                <table class="r4-table">
                    <thead>
                        <tr>
                            <th>Submission Date</th>
                            <th>LEA District</th>
                            <th>Last Action</th>
                            <th>Total Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var group in disbursementGroups)
                        {
                            <tr>
                                <td>@group.SubmissionDate.ToString("MM/dd/yyyy")</td>
                                <td>@group.LEA</td>
                                <td>
                                    @group.LastAction: @group.LastActionDate.ToString("MM/dd/yyyy")
                                </td>
                                <td>@group.Amount.ToString("C0")</td>
                                <td>
                                    @if (group.State == "NEEDS_GAA")
                                    {
                                        <div style="width: 160px; display: block;">
                                            <a href="@Url.Action("GAA", "FiscalTeam", new { id = group.Id })" class="r4-button r4-button-sm r4-button-primary">
                                                <i class="mdi mdi-file-plus-outline"></i> Generate GAA
                                            </a>
                                        </div>
                                    }
                                    else if (group.State == "NEEDS_INVOICE")
                                    {
                                        <div style="width: 160px; display: block;">
                                            <a href="@Url.Action("GenerateInvoice", "FiscalTeam", new { id = group.Id })" class="r4-button r4-button-sm r4-button-primary">
                                                <i class="mdi mdi-file-plus-outline"></i> Generate Invoice
                                            </a>
                                        </div>
                                    }
                                    else if (group.State == "INVOICE_GENERATED")
                                    {
                                        <div style="width: 160px; display: block;">
                                            <a href="@Url.Action("ViewInvoice", "FiscalTeam", new { id = group.Id })" class="r4-button r4-button-sm">
                                                <i class="mdi mdi-file-eye-outline"></i> View Invoice
                                            </a>
                                        </div>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <p class="text-muted"><i class="mdi mdi-check-circle-outline"></i> All caught up! No disbursement groups currently in the processing pipeline.</p>
        }
    </div>
</div>

@* Budget Overview - Simplified *@
<div class="r4-card">
    <div class="r4-card-header">
        <h4><i class="mdi mdi-chart-bar"></i> Budget Overview</h4>
        <div class="card-actions">
            <a href="@Url.Action("Analytics", "GrantsTeam", new { grantCycleId = Model.GrantCycleId })" class="r4-button r4-button-sm">
                <i class="mdi mdi-chart-box-outline"></i> View Full Analytics
            </a>
        </div>
    </div>
    <div class="r4-card-body">
        @{
            var encumberedM = Model.Metrics.EncumberedAmount / 1000000m;
            var disbursedM = Model.Metrics.DisbursedAmount / 1000000m;
            var remainingM = Model.Metrics.RemainingAmount / 1000000m;
            var encumberedPercent = Model.Metrics.ApproprietedAmount > 0
                ? (Model.Metrics.EncumberedAmount / Model.Metrics.ApproprietedAmount * 100)
                : 0;
            var disbursedPercent = Model.Metrics.ApproprietedAmount > 0
                ? (Model.Metrics.DisbursedAmount / Model.Metrics.ApproprietedAmount * 100)
                : 0;
            var remainingPercent = 100 - encumberedPercent - disbursedPercent;
        }

        <h5>Budget Utilization</h5>
        <div class="r4-progress" style="height: 40px; position: relative; display: flex;">
            @if (encumberedPercent > 0.1m)
            {
                <div class="r4-progress-bar r4-progress-bar-encumbered"
                     style="width: @encumberedPercent%; display: flex; align-items: center; justify-content: center; color: var(--white); font-size: 0.875rem; font-weight: 600; padding: 0 0.5rem;"
                     role="progressbar"
                     aria-valuenow="@encumberedPercent"
                     aria-valuemin="0"
                     aria-valuemax="100"
                     title="@encumberedPercent.ToString("F1")% of total budget">
                    @if (encumberedPercent > 12)
                    {
                        <span>$@encumberedM.ToString("F1")M Encumbered</span>
                    }
                </div>
            }
            @if (disbursedPercent > 0.1m)
            {
                <div class="r4-progress-bar r4-progress-bar-disbursed"
                     style="width: @disbursedPercent%; display: flex; align-items: center; justify-content: center; color: var(--white); font-size: 0.875rem; font-weight: 600; padding: 0 0.5rem;"
                     role="progressbar"
                     aria-valuenow="@disbursedPercent"
                     aria-valuemin="0"
                     aria-valuemax="100"
                     title="@disbursedPercent.ToString("F1")% of total budget">
                    @if (disbursedPercent > 12)
                    {
                        <span>$@disbursedM.ToString("F1")M Disbursed</span>
                    }
                </div>
            }
            @if (remainingPercent > 0.1m)
            {
                <div style="flex: 1; background-color: var(--gray-200); display: flex; align-items: center; justify-content: center; color: var(--gray-700); font-size: 0.875rem; font-weight: 600; padding: 0 0.5rem;"
                     title="@remainingPercent.ToString("F1")% of total budget">
                    @if (remainingPercent > 12)
                    {
                        <span>$@remainingM.ToString("F1")M Remaining</span>
                    }
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Auto-refresh dashboard every 5 minutes
        setTimeout(function() {
            location.reload();
        }, 300000);
    </script>
}
