@model LEABulkUploadViewModel

@{
    ViewData["Title"] = "Bulk Upload Reports";
}

@section Breadcrumbs {
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="@Url.Action("Dashboard", "LEAPortal", new { leaId = Model.LEAId, grantCycleId = Model.GrantCycleId })">LEA Portal</a></li>
        <li class="breadcrumb-item"><a href="@Url.Action("Reports", "LEAPortal", new { leaId = Model.LEAId, grantCycleId = Model.GrantCycleId })">Reporting</a></li>
        <li class="breadcrumb-item active">Bulk Upload</li>
    </ol>
}

<div class="page-header">
    <h2><i class="mdi mdi-file-upload-outline"></i> Bulk Upload Reports</h2>
    <p class="subtitle">@Model.LEAName - @Model.GrantCycleName</p>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">
        <i class="mdi mdi-check-circle-outline"></i> @TempData["Success"]
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">
        <i class="mdi mdi-alert-circle-outline"></i> @TempData["Error"]
    </div>
}

@* Instructions *@
<div class="r4-card">
    <div class="r4-card-header">
        <h4><i class="mdi mdi-information-outline"></i> How to Use Bulk Upload</h4>
    </div>
    <div class="r4-card-body">
        <ol style="line-height: 1.8;">
            <li><strong>Download the Template:</strong> Click the button below to download a pre-populated Excel template with all your funded candidates.</li>
            <li><strong>Fill in Report Data:</strong> Complete the required fields in the template for each candidate.</li>
            <li><strong>Upload the File:</strong> Upload the completed Excel file using the form below.</li>
            <li><strong>Review Results:</strong> Check for any errors and correct them if needed.</li>
            <li><strong>Submit:</strong> Once all data is validated, reports will be created for your candidates.</li>
        </ol>

        <div style="margin-top: 1rem;">
            <a href="#" class="r4-button r4-button-primary" onclick="alert('Template download functionality will be implemented with Excel generation library.'); return false;">
                <i class="mdi mdi-download"></i> Download Pre-Populated Template
            </a>
            <a href="#" class="r4-button" onclick="alert('Blank template download functionality will be implemented.'); return false;">
                <i class="mdi mdi-file-download-outline"></i> Download Blank Template
            </a>
        </div>
    </div>
</div>

@* Upload Form *@
<div class="r4-card">
    <div class="r4-card-header">
        <h4><i class="mdi mdi-upload"></i> Upload Completed Template</h4>
    </div>
    <div class="r4-card-body">
        <form asp-action="BulkUpload" method="post" enctype="multipart/form-data">
            <input type="hidden" asp-for="LEAId" />
            <input type="hidden" asp-for="GrantCycleId" />

            <div class="form-group">
                <label asp-for="UploadFile" class="required"></label>
                <input asp-for="UploadFile" type="file" class="form-control" accept=".xlsx,.xls,.csv" required />
                <small class="form-text text-muted">
                    Accepted formats: Excel (.xlsx, .xls) or CSV (.csv)
                </small>
            </div>

            <div class="form-actions">
                <button type="submit" class="r4-button r4-button-primary">
                    <i class="mdi mdi-upload"></i> Upload and Process
                </button>
                <a href="@Url.Action("Reports", "LEAPortal", new { leaId = Model.LEAId, grantCycleId = Model.GrantCycleId })" class="r4-button r4-button-secondary">
                    <i class="mdi mdi-arrow-left"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>

@* Results (if processing complete) *@
@if (Model.ProcessingComplete)
{
    <div class="r4-card">
        <div class="r4-card-header">
            <h4><i class="mdi mdi-file-chart-outline"></i> Upload Results</h4>
        </div>
        <div class="r4-card-body">
            <div class="dashboard-grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="metric-card metric-approved">
                    <div class="metric-icon">
                        <i class="mdi mdi-check-circle-outline"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value">@Model.SuccessCount</div>
                        <div class="metric-label">Successful</div>
                        <div class="metric-description">Reports created successfully</div>
                    </div>
                </div>

                @if (Model.ErrorCount > 0)
                {
                    <div class="metric-card metric-overdue">
                        <div class="metric-icon">
                            <i class="mdi mdi-alert-circle-outline"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-value">@Model.ErrorCount</div>
                            <div class="metric-label">Errors</div>
                            <div class="metric-description">Rows with validation errors</div>
                        </div>
                    </div>
                }
            </div>

            @if (Model.Results.Any())
            {
                <table class="r4-table" style="margin-top: 1.5rem;">
                    <thead>
                        <tr>
                            <th>Row</th>
                            <th>SEID</th>
                            <th>Candidate Name</th>
                            <th>Status</th>
                            <th>Errors</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var result in Model.Results)
                        {
                            <tr class="@(!result.Success ? "error-row" : "")">
                                <td>@result.RowNumber</td>
                                <td>@result.SEID</td>
                                <td>@result.StudentName</td>
                                <td>
                                    @if (result.Success)
                                    {
                                        <span class="badge badge-success">Success</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-danger">Error</span>
                                    }
                                </td>
                                <td>
                                    @if (!result.Success)
                                    {
                                        <span class="text-danger">@result.ErrorSummary</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }

            <div class="form-actions" style="margin-top: 1.5rem;">
                @if (Model.ErrorCount == 0)
                {
                    <a href="@Url.Action("FundedCandidates", "LEAPortal", new { leaId = Model.LEAId, grantCycleId = Model.GrantCycleId })" class="r4-button r4-button-primary">
                        <i class="mdi mdi-check"></i> View Funded Candidates
                    </a>
                }
                else
                {
                    <button type="button" class="r4-button r4-button-primary" onclick="alert('Download error report functionality will be implemented.')">
                        <i class="mdi mdi-download"></i> Download Error Report
                    </button>
                }
                <a href="@Url.Action("BulkUpload", "LEAPortal", new { leaId = Model.LEAId, grantCycleId = Model.GrantCycleId })" class="r4-button">
                    <i class="mdi mdi-refresh"></i> Upload Another File
                </a>
            </div>
        </div>
    </div>
}
