@{
    ViewData["Title"] = ViewBag.ReportTitle;
    ViewBag.ReportType = "Outcomes";
    ViewBag.ReportId = (int?)null;

    // Current year data
    var currentYear = new {
        TotalFunded = 214,
        ProgramCompleted = 187,
        CompletionRate = 87.4,
        CredentialsEarned = 162,
        CredentialRate = 86.6,
        Employed = 158,
        EmploymentRate = 84.5,
        HiredInDistrict = 142,
        HiredInDistrictRate = 89.9
    };

    // Prior year for comparison
    var priorYear = new {
        TotalFunded = 198,
        CompletionRate = 82.3,
        CredentialRate = 80.1,
        EmploymentRate = 79.8,
        HiredInDistrictRate = 85.2
    };

    // Targets
    var targets = new {
        CompletionRate = 85.0,
        CredentialRate = 80.0,
        EmploymentRate = 80.0,
        HiredInDistrictRate = 75.0
    };

    // Credential area outcomes (aggregated, no IHE detail)
    var credentialOutcomes = new[] {
        new { Area = "Multiple Subject", Funded = 68, Completed = 62, CompletionRate = 91.2, Credentialed = 58, CredentialRate = 93.5, Employed = 54, EmploymentRate = 93.1, Assessment = "Strong" },
        new { Area = "Single Subject - Math", Funded = 42, Completed = 35, CompletionRate = 83.3, Credentialed = 33, CredentialRate = 94.3, Employed = 31, EmploymentRate = 93.9, Assessment = "On Track" },
        new { Area = "Single Subject - English", Funded = 28, Completed = 24, CompletionRate = 85.7, Credentialed = 22, CredentialRate = 91.7, Employed = 20, EmploymentRate = 90.9, Assessment = "On Track" },
        new { Area = "Single Subject - Science", Funded = 24, Completed = 20, CompletionRate = 83.3, Credentialed = 19, CredentialRate = 95.0, Employed = 18, EmploymentRate = 94.7, Assessment = "On Track" },
        new { Area = "Education Specialist", Funded = 52, Completed = 46, CompletionRate = 88.5, Credentialed = 30, CredentialRate = 65.2, Employed = 35, EmploymentRate = 76.1, Assessment = "Needs Attention" }
    };

    // Helper functions
    Func<double, double, string> getTrend = (current, prior) => {
        var diff = current - prior;
        if (diff > 0) return $"<span style=\"color: var(--success);\">+{diff:F1}%</span>";
        if (diff < 0) return $"<span style=\"color: var(--danger);\">{diff:F1}%</span>";
        return "<span style=\"color: var(--gray-500);\">No change</span>";
    };

    Func<double, double, string> getTargetStatus = (actual, target) => {
        if (actual >= target) return "<span style=\"color: var(--success);\"><i class=\"mdi mdi-check-circle\"></i></span>";
        return "<span style=\"color: var(--warning);\"><i class=\"mdi mdi-alert\"></i></span>";
    };
}

@section Breadcrumbs {
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="@Url.Action("Dashboard", "GrantsTeam")">Grants Team</a></li>
        <li class="breadcrumb-item"><a href="@Url.Action("Dashboard", "Reporting")">Reporting</a></li>
        <li class="breadcrumb-item active">Program Impact Report</li>
    </ol>
}

<div class="page-header" style="margin-bottom: 1rem;">
    <h2><i class="mdi mdi-chart-line"></i> @ViewBag.ReportTitle</h2>
    <p class="subtitle">Is the program achieving its goals?</p>
</div>

<!-- Report Export Toolbar -->
@await Html.PartialAsync("_ReportExportToolbar")

<!-- Report Metadata -->
<div class="r4-card">
    <div class="r4-card-body" style="display: flex; justify-content: space-between; padding: 1rem 1.5rem; background: var(--gray-100);">
        <div><strong>Grant Cycle:</strong> @ViewBag.GrantCycle</div>
        <div><strong>Program:</strong> Student Teacher Stipend Program</div>
        <div><strong>Generated:</strong> @(((DateTime)ViewBag.GeneratedDate).ToString("MMMM d, yyyy"))</div>
    </div>
</div>

<!-- Program Goals vs Actuals -->
<div class="r4-card">
    <div class="r4-card-header">
        <h4><i class="mdi mdi-target"></i> Program Goals vs Actuals</h4>
    </div>
    <div class="r4-card-body">
        <table class="r4-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th style="text-align: right;">Target</th>
                    <th style="text-align: right;">FY 2023-24</th>
                    <th style="text-align: right;">FY 2024-25</th>
                    <th style="text-align: center;">YoY Change</th>
                    <th style="text-align: center;">Status</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Program Completion Rate</strong></td>
                    <td style="text-align: right;">@targets.CompletionRate%</td>
                    <td style="text-align: right;">@priorYear.CompletionRate%</td>
                    <td style="text-align: right;">@currentYear.CompletionRate%</td>
                    <td style="text-align: center;">@Html.Raw(getTrend(currentYear.CompletionRate, priorYear.CompletionRate))</td>
                    <td style="text-align: center;">@Html.Raw(getTargetStatus(currentYear.CompletionRate, targets.CompletionRate))</td>
                </tr>
                <tr>
                    <td><strong>Credential Attainment Rate</strong></td>
                    <td style="text-align: right;">@targets.CredentialRate%</td>
                    <td style="text-align: right;">@priorYear.CredentialRate%</td>
                    <td style="text-align: right;">@currentYear.CredentialRate%</td>
                    <td style="text-align: center;">@Html.Raw(getTrend(currentYear.CredentialRate, priorYear.CredentialRate))</td>
                    <td style="text-align: center;">@Html.Raw(getTargetStatus(currentYear.CredentialRate, targets.CredentialRate))</td>
                </tr>
                <tr>
                    <td><strong>Employment Rate</strong></td>
                    <td style="text-align: right;">@targets.EmploymentRate%</td>
                    <td style="text-align: right;">@priorYear.EmploymentRate%</td>
                    <td style="text-align: right;">@currentYear.EmploymentRate%</td>
                    <td style="text-align: center;">@Html.Raw(getTrend(currentYear.EmploymentRate, priorYear.EmploymentRate))</td>
                    <td style="text-align: center;">@Html.Raw(getTargetStatus(currentYear.EmploymentRate, targets.EmploymentRate))</td>
                </tr>
                <tr>
                    <td><strong>Hired in Sponsoring District</strong></td>
                    <td style="text-align: right;">@targets.HiredInDistrictRate%</td>
                    <td style="text-align: right;">@priorYear.HiredInDistrictRate%</td>
                    <td style="text-align: right;">@currentYear.HiredInDistrictRate%</td>
                    <td style="text-align: center;">@Html.Raw(getTrend(currentYear.HiredInDistrictRate, priorYear.HiredInDistrictRate))</td>
                    <td style="text-align: center;">@Html.Raw(getTargetStatus(currentYear.HiredInDistrictRate, targets.HiredInDistrictRate))</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Three-Year Trend -->
<div class="r4-card">
    <div class="r4-card-header">
        <h4><i class="mdi mdi-chart-line"></i> Three-Year Outcome Trends</h4>
    </div>
    <div class="r4-card-body">
        <!-- Dashboard View: Chart + Summary -->
        <div class="dashboard-view" style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
            <div>
                <canvas id="trendChart" style="max-height: 280px;"></canvas>
            </div>
            <div>
                <h5 style="margin-bottom: 1rem;">Key Observations</h5>
                <ul style="margin: 0; padding-left: 1.25rem; line-height: 1.8;">
                    <li>All four outcome metrics show <strong>consistent upward trends</strong></li>
                    <li>Completion rate improved <strong>+7.9 pts</strong> over three years</li>
                    <li>Credential attainment reached all-time high of <strong>@currentYear.CredentialRate%</strong></li>
                    <li>District retention exceeds <strong>@currentYear.HiredInDistrictRate%</strong> for first time</li>
                </ul>
            </div>
        </div>
        <!-- Formal View: Accessible table -->
        <div class="formal-view" style="display: none;">
            <table class="r4-table" aria-label="Three-Year Outcome Trends">
                <caption class="sr-only">Program outcome metrics over three fiscal years</caption>
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th style="text-align: right;">FY 2022-23</th>
                        <th style="text-align: right;">FY 2023-24</th>
                        <th style="text-align: right;">FY 2024-25</th>
                        <th style="text-align: right;">3-Year Change</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Completion Rate</strong></td>
                        <td style="text-align: right;">79.5%</td>
                        <td style="text-align: right;">82.3%</td>
                        <td style="text-align: right;">87.4%</td>
                        <td style="text-align: right; color: var(--success);">+7.9 pts</td>
                    </tr>
                    <tr>
                        <td><strong>Credential Rate</strong></td>
                        <td style="text-align: right;">76.2%</td>
                        <td style="text-align: right;">80.1%</td>
                        <td style="text-align: right;">86.6%</td>
                        <td style="text-align: right; color: var(--success);">+10.4 pts</td>
                    </tr>
                    <tr>
                        <td><strong>Employment Rate</strong></td>
                        <td style="text-align: right;">75.8%</td>
                        <td style="text-align: right;">79.8%</td>
                        <td style="text-align: right;">84.5%</td>
                        <td style="text-align: right; color: var(--success);">+8.7 pts</td>
                    </tr>
                    <tr>
                        <td><strong>In-District Hire Rate</strong></td>
                        <td style="text-align: right;">80.1%</td>
                        <td style="text-align: right;">85.2%</td>
                        <td style="text-align: right;">89.9%</td>
                        <td style="text-align: right; color: var(--success);">+9.8 pts</td>
                    </tr>
                </tbody>
            </table>
            <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--gray-600);">
                <strong>Key Observations:</strong> All four outcome metrics show consistent upward trends over three years.
                Completion rate improved 7.9 percentage points. Credential attainment reached an all-time high of @currentYear.CredentialRate%.
            </p>
        </div>
    </div>
</div>

<!-- Outcomes by Credential Area -->
<div class="r4-card">
    <div class="r4-card-header">
        <h4><i class="mdi mdi-certificate-outline"></i> Outcomes by Credential Area</h4>
    </div>
    <div class="r4-card-body">
        <table class="r4-table">
            <thead>
                <tr>
                    <th>Credential Area</th>
                    <th style="text-align: right;">Funded</th>
                    <th style="text-align: right;">Completion</th>
                    <th style="text-align: right;">Credential</th>
                    <th style="text-align: right;">Employment</th>
                    <th style="text-align: center;">Assessment</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in credentialOutcomes)
                {
                    <tr>
                        <td><strong>@item.Area</strong></td>
                        <td style="text-align: right;">@item.Funded</td>
                        <td style="text-align: right;">
                            <span class="status-badge @(item.CompletionRate >= 85 ? "status-success" : "status-warning")">@item.CompletionRate.ToString("F0")%</span>
                        </td>
                        <td style="text-align: right;">
                            <span class="status-badge @(item.CredentialRate >= 80 ? "status-success" : "status-warning")">@item.CredentialRate.ToString("F0")%</span>
                        </td>
                        <td style="text-align: right;">
                            <span class="status-badge @(item.EmploymentRate >= 80 ? "status-success" : "status-warning")">@item.EmploymentRate.ToString("F0")%</span>
                        </td>
                        <td style="text-align: center;">
                            @if (item.Assessment == "Strong")
                            {
                                <span style="color: var(--success); font-weight: 600;"><i class="mdi mdi-check-circle"></i> @item.Assessment</span>
                            }
                            else if (item.Assessment == "On Track")
                            {
                                <span style="color: var(--info); font-weight: 600;"><i class="mdi mdi-progress-check"></i> @item.Assessment</span>
                            }
                            else
                            {
                                <span style="color: var(--warning); font-weight: 600;"><i class="mdi mdi-alert"></i> @item.Assessment</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr style="font-weight: 600; background: var(--gray-100);">
                    <td>Program Total</td>
                    <td style="text-align: right;">@currentYear.TotalFunded</td>
                    <td style="text-align: right;">@currentYear.CompletionRate%</td>
                    <td style="text-align: right;">@currentYear.CredentialRate%</td>
                    <td style="text-align: right;">@currentYear.EmploymentRate%</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
        <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--gray-600);">
            <i class="mdi mdi-information-outline"></i>
            Education Specialist shows lower credential rate (65%) due to longer program requirements. Recommend targeted support for this pathway.
        </p>
    </div>
</div>

<!-- Program Impact -->
<div class="r4-card">
    <div class="r4-card-header">
        <h4><i class="mdi mdi-star-outline"></i> Program Impact</h4>
    </div>
    <div class="r4-card-body">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem;">
            <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, var(--ctc-blue) 0%, #2a5a8f 100%); border-radius: 8px; color: white;">
                <div style="font-size: 3rem; font-weight: 700;">@currentYear.CredentialsEarned</div>
                <div style="font-size: 0.875rem; opacity: 0.9;">New Credentialed Teachers</div>
            </div>
            <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, var(--success) 0%, #1e7e34 100%); border-radius: 8px; color: white;">
                <div style="font-size: 3rem; font-weight: 700;">@currentYear.HiredInDistrict</div>
                <div style="font-size: 0.875rem; opacity: 0.9;">Hired in Sponsoring District</div>
            </div>
            <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, var(--ctc-gold) 0%, #a67c10 100%); border-radius: 8px; color: white;">
                <div style="font-size: 3rem; font-weight: 700;">$2.14M</div>
                <div style="font-size: 0.875rem; opacity: 0.9;">Total Investment</div>
            </div>
            <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%); border-radius: 8px; color: white;">
                <div style="font-size: 3rem; font-weight: 700;">$13,210</div>
                <div style="font-size: 0.875rem; opacity: 0.9;">Cost per Credential</div>
            </div>
        </div>
    </div>
</div>

<!-- Report Footer -->
<div style="margin-top: 2rem; padding: 1rem; border-top: 1px solid var(--gray-300); color: var(--gray-500); font-size: 0.75rem; display: flex; justify-content: space-between;">
    <div>California Commission on Teacher Credentialing - Confidential Internal Use Only</div>
    <div>Generated: @((DateTime)ViewBag.GeneratedDate).ToString("MM/dd/yyyy HH:mm")</div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        new Chart(document.getElementById('trendChart'), {
            type: 'line',
            data: {
                labels: ['FY 2022-23', 'FY 2023-24', 'FY 2024-25'],
                datasets: [
                    {
                        label: 'Completion Rate',
                        data: [79.5, 82.3, 87.4],
                        borderColor: '#1E3A5F',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        tension: 0.3
                    },
                    {
                        label: 'Credential Rate',
                        data: [76.2, 80.1, 86.6],
                        borderColor: '#C69214',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        tension: 0.3
                    },
                    {
                        label: 'Employment Rate',
                        data: [75.8, 79.8, 84.5],
                        borderColor: '#28A745',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        tension: 0.3
                    },
                    {
                        label: 'In-District Hire',
                        data: [80.1, 85.2, 89.9],
                        borderColor: '#6f42c1',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 20, usePointStyle: true }
                    }
                },
                scales: {
                    y: {
                        min: 70,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    </script>
}

@section Styles {
    <link rel="stylesheet" href="~/css/report-print.css" />
}
