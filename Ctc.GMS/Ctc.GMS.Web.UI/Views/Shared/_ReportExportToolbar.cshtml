@*
    Report Export Toolbar - Shared partial for all reports
    Provides: View mode toggle (Formal/Dashboard), PDF/Excel/Print exports

    Usage: @await Html.PartialAsync("_ReportExportToolbar", new { ReportType = "Demographics", ReportId = 1 })

    Required ViewBag properties:
    - ReportType: string identifying the report (e.g., "Demographics", "Financial", "LEA", "Outcomes")
    - ReportId: optional int for reports that need an ID parameter
*@

@{
    var reportType = ViewBag.ReportType ?? "Report";
    var reportId = ViewBag.ReportId;
    var reportTitle = ViewBag.ReportTitle ?? "Report";
}

<div class="report-toolbar" style="margin-bottom: 1.5rem;">
    <!-- View Mode Toggle -->
    <div class="r4-card" style="margin-bottom: 1rem;">
        <div class="r4-card-body" style="padding: 1rem 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <!-- View Mode Selection -->
                <div class="view-mode-toggle" style="display: flex; align-items: center; gap: 1rem;">
                    <span style="font-weight: 600; color: var(--gray-700);">View Mode:</span>
                    <div class="r4-button-group" role="group" aria-label="Report view mode">
                        <button type="button"
                                class="r4-button r4-button-secondary view-mode-btn active"
                                data-mode="dashboard"
                                aria-pressed="true">
                            <i class="mdi mdi-chart-bar"></i> Dashboard View
                        </button>
                        <button type="button"
                                class="r4-button r4-button-secondary view-mode-btn"
                                data-mode="formal"
                                aria-pressed="false">
                            <i class="mdi mdi-file-document-outline"></i> Formal Report
                            <span style="font-size: 0.7rem; opacity: 0.8; margin-left: 0.25rem;">(ADA)</span>
                        </button>
                    </div>
                </div>

                <!-- Export Actions -->
                <div class="report-actions" style="display: flex; gap: 0.5rem;">
                    <a href="@Url.Action("ExportPdf", "Reporting", new { reportType = reportType, id = reportId })"
                       class="r4-button r4-button-primary"
                       title="Export as PDF (ADA Compliant - Tables Only)">
                        <i class="mdi mdi-file-pdf-box"></i> Export PDF
                    </a>
                    <a href="@Url.Action("ExportExcel", "Reporting", new { reportType = reportType, id = reportId })"
                       class="r4-button r4-button-secondary"
                       title="Export as Excel (Raw Data Tables)">
                        <i class="mdi mdi-file-excel"></i> Export Excel
                    </a>
                    <button type="button"
                            class="r4-button r4-button-secondary"
                            onclick="window.print();"
                            title="Print Report">
                        <i class="mdi mdi-printer"></i> Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Formal Report Notice (hidden by default) -->
    <div class="formal-mode-notice" style="display: none;">
        <div class="r4-alert r4-alert-info" style="margin-bottom: 1rem;">
            <i class="mdi mdi-information-outline"></i>
            <strong>Formal Report Mode:</strong> Displaying ADA-compliant tables only. Charts are hidden for accessibility compliance.
            <a href="#" class="switch-to-dashboard" style="margin-left: 0.5rem;">Switch to Dashboard View</a>
        </div>
    </div>
</div>

<style>
    /* Button Group Styling */
    .r4-button-group {
        display: inline-flex;
        border-radius: 4px;
        overflow: hidden;
    }

    .r4-button-group .r4-button {
        border-radius: 0;
        margin: 0;
        border-right: 1px solid var(--gray-300);
    }

    .r4-button-group .r4-button:first-child {
        border-radius: 4px 0 0 4px;
    }

    .r4-button-group .r4-button:last-child {
        border-radius: 0 4px 4px 0;
        border-right: none;
    }

    .r4-button-group .r4-button.active {
        background: var(--ctc-blue);
        color: white;
        border-color: var(--ctc-blue);
    }

    /* View Mode Visibility */
    .dashboard-view {
        display: block;
    }

    .formal-view {
        display: none !important;
    }

    body.formal-mode .dashboard-view {
        display: none !important;
    }

    body.formal-mode .formal-view {
        display: block !important;
    }

    body.formal-mode .formal-mode-notice {
        display: block !important;
    }

    /* Print Styles - Always use formal mode */
    @@media print {
        .report-toolbar,
        .formal-mode-notice,
        .dashboard-view {
            display: none !important;
        }

        .formal-view {
            display: block !important;
        }
    }
</style>

<script>
    (function() {
        function initReportToolbar() {
            const viewModeBtns = document.querySelectorAll('.view-mode-btn');
            const formalNotice = document.querySelector('.formal-mode-notice');
            const switchToDashboard = document.querySelector('.switch-to-dashboard');

            if (!viewModeBtns.length) return; // Not ready yet

            window.setReportViewMode = function(mode) {
                viewModeBtns.forEach(btn => {
                    const isActive = btn.dataset.mode === mode;
                    btn.classList.toggle('active', isActive);
                    btn.setAttribute('aria-pressed', isActive);
                });

                // Toggle visibility of dashboard-view and formal-view elements
                const dashboardViews = document.querySelectorAll('.dashboard-view');
                const formalViews = document.querySelectorAll('.formal-view');

                if (mode === 'formal') {
                    document.body.classList.add('formal-mode');
                    if (formalNotice) formalNotice.style.display = 'block';

                    // Hide dashboard views, show formal views
                    dashboardViews.forEach(el => {
                        el.setAttribute('data-original-style', el.getAttribute('style') || '');
                        el.style.cssText = 'display: none !important';
                    });
                    formalViews.forEach(el => {
                        el.style.cssText = 'display: block !important';
                    });
                } else {
                    document.body.classList.remove('formal-mode');
                    if (formalNotice) formalNotice.style.display = 'none';

                    // Show dashboard views, hide formal views
                    dashboardViews.forEach(el => {
                        const originalStyle = el.getAttribute('data-original-style') || '';
                        el.setAttribute('style', originalStyle);
                    });
                    formalViews.forEach(el => {
                        el.style.cssText = 'display: none !important';
                    });
                }

                // Store preference
                localStorage.setItem('reportViewMode', mode);
            };

            // Click handlers for view mode buttons
            viewModeBtns.forEach(btn => {
                btn.addEventListener('click', () => window.setReportViewMode(btn.dataset.mode));
            });

            // Switch to dashboard link
            if (switchToDashboard) {
                switchToDashboard.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.setReportViewMode('dashboard');
                });
            }

            // Restore saved preference (default to dashboard)
            const savedMode = localStorage.getItem('reportViewMode') || 'dashboard';
            window.setReportViewMode(savedMode);
        }

        // Run init when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initReportToolbar);
        } else {
            // DOM already loaded, run after a short delay to ensure all elements exist
            setTimeout(initReportToolbar, 100);
        }
    })();
</script>
